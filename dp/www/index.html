<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
        <title>Blank App</title>
    </head>
    <body>
        <div id="connect">Not Connected</div>
        <div id="scan">&nbsp;</div>
        <button onClick="scan();">Scan</button>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript">
        var connectToDevice;

        function stringToBytes ( str ) {
  var ch, st, re = [];
  for (var i = 0; i < str.length; i++ ) {
    ch = str.charCodeAt(i);  // get char 
    st = [];                 // set up "stack"
    do {
      st.push( ch & 0xFF );  // push byte to stack
      ch = ch >> 8;          // shift value down by 1 byte
    }  
    while ( ch );
    // add stack contents to result
    // done because chars have "wrong" endianness
    re = re.concat( st.reverse() );
  }
  // return an array of bytes
  return re;
}
            function scan(){
                document.getElementById('scan').innerHTML = 'Scanning...';
               ble.startScan([], function(device) {
                 var con = confirm('Connect to ' + device.name + '?');  
                 if(con){
                     document.getElementById('connect').innerHTML = 'Connected: ' + device.name;
                     connectToDevice = device.id;
                     ble.stopScan(function(){
                        ble.connect(connectToDevice, function (connected) { 
                            alert("Connected!"+ connected);
                            ble.startNotification(device.id, '0000fee4-0000-1000-8000-00805f9b34fb', '2a1e0005-fd51-d882-8ba8-b98c0000cd1e', function(val){
                                var hex = [];
                                var res = bluetoothle.bytesToString(val);
                                for(var i = 0; i<res.length; i++) hex.push(res[i].toString(16));
                                alert(stringToBytes(hex));
                            }, function(err){
                                alert('Error in notification: ' + JSON.stringify(err));
                            });
                         }, function (err) { 
                             document.getElementById('connect').innerHTML = 'Not Connected: ';
                             ble.connect(connectToDevice, connectedDevice, disconnectedDevice) 
                        }) 
                     });
                     
                 }
            }, function(err){alert("Scan failed: " + err)});

            setTimeout(ble.stopScan,
                10000,
                function() { document.getElementById('scan').innerHTML = "&nbsp;"; }
            );
            }

            

                         
        </script>
    </body>
</html>
